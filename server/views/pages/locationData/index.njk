{% extends "../../partials/fullWidthLayout.njk" %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "../../components/datatable/macro.njk" import dataTable %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "../../components/date-time-picker/macro.njk" import dateTimePicker %}

{% set pageTitle = applicationName + " - Persons Search" %}
{% set mainClasses = "app-container govuk-body device-activation-search" %}
{% set pageType = "index" %}
{% set rows = [] %}
{% set pageSize = 10 %}
{% set currentPage = 1 %}
{% set totalPages = (persons.length / pageSize) | round(0, 'ceil') %}
{% set activeLinkId = "location-data" %}

{% if searchField === 'name' %}
  {% set name = searchTerm %}
{% elif searchField === 'nomisId' %}
  {% set nomisId = searchTerm %}
{% elif searchField === 'deviceId' %}
  {% set deviceId = searchTerm %}
{% endif %}

{% set nameHtml %}
  {{ govukInput({
    id: "name",
    name: "name",
    value: name
  }) }}
{% endset %}

{% set nomisIdHtml %}
{{ govukInput({
  id: "nomis-id",
  name: "nomisId",
  value: nomisId
}) }}
{% endset %}

{% set deviceIdHtml %}
{{ govukInput({
  id: "device-id",
  name: "deviceId",
  value: deviceId
}) }}
{% endset %}

{% for person in persons %}
  {% for deviceActivation in person.deviceActivations %}
    {% set selected = ' checked' if formData.deviceActivationId == deviceActivation.deviceActivationId else '' %}
    {%
      set rows = (rows.push(
        [
          {
            html: '<div class="govuk-radios__item govuk-radios--small">
                    <input type="radio" class="govuk-radios__input" name="deviceActivationId" id="' + deviceActivation.deviceActivationId + '" value="' + deviceActivation.deviceActivationId + '" autocomplete="off"' + selected +'>
                    <label class="govuk-label govuk-radios__label" for="' + deviceActivation.deviceActivationId + '">
                    </label>
                  </div>',
            classes: "person-table__column-radio"
          },
          {
            text: person.nomisId
          },
          {
            text: person.name
          },
          {
            text: person.dateOfBirth | formatDob
          },
          {
            text: person.address,
            classes: "person-table__column-address"
          },
          {
            text: deviceActivation.deviceId
          },
          {
            text: deviceActivation.deviceActivationDate | formatDate
          },
          {
            text: deviceActivation.deviceDeactivationDate | formatDate
          }
        ]
      ), rows)
    %}
  {% endfor %}
{% endfor %}

{% block content %}
  <h1 class="govuk-heading-m">Search Location Data</h1>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-quarter">
      <form method="post" novalidate id="person-search-form">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
        {{ govukRadios({
          classes: "govuk-radios--small",
          name: "searchField",
          fieldset: {
            legend: {
              text: "Search",
              classes: "govuk-fieldset__legend--s"
            }
          },
          errorMessage: errors.searchField,
          items: [
            {
              value: "name",
              text: "Name",
              checked: searchField === 'name',
              conditional: {
                html: nameHtml
              }
            },
            {
              value: "nomisId",
              text: "NOMIS ID",
              checked: searchField === 'nomisId',
              conditional: {
                html: nomisIdHtml
              }
            },
            {
              value: "deviceId",
              text: "Device ID",
              checked: searchField === 'deviceId',
              conditional: {
                html: deviceIdHtml
              }
            }
          ]
        }) }}

        {{
          govukButton({
            id: "search-persons-button",
            text: "Search",
            name: "action"
          })
        }}
      </form>
      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible" />
      {% include "./partials/dateFilterForm.njk" %}
    </div>

    <div class="govuk-grid-column-three-quarters">
      <h2 class="govuk-heading-s">
        Results
      </h2>
      {{
        dataTable({
          classes: "person-table",
          columns: [
            {
              text: "",
              classes: "person-table__head-radio"
            },
            {
              text: "NOMIS ID"
            },
            {
              text: "Name"
            },
            {
              text: "Date of Birth"
            },
            {
              text: "Address",
              classes: "person-table__head-address"
            },
            {
              text: "Device ID"
            },
            {
              text: "Tag Period Start",
              classes: "person-table__head-tag-start"
            },
            {
              text: "Tag Period End",
              classes: "person-table__head-tag-end"
            }
          ],
          rows: rows,
          pagination: {
            pageCount: pageCount,
            currentPage: pageNumber,
            hrefPrefix: "?searchField=" + searchField + '&searchTerm=' + searchTerm
          }
        })
      }}
    </div>
  </div>
{% endblock %}
